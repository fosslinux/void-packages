# Template file for 'mup'
pkgname=mup
version=6.9
revision=1
build_style=gnu-configure
hostmakedepends="ghostscript groff flex bison netpbm automake"
makedepends="fltk-devel libXpm-devel"
short_desc="Free, yet very feature rich, music publication program"
maintainer="fosslinux <fosslinux@aussies.space>"
license="BSD-3-Clause"
homepage="http://www.arkkra.com/"
distfiles="ftp://ftp.arkkra.com/pub/unix/mup${version//.}src.tar.gz"
checksum=75380d13f6478716471ac4a3aff800097a7b57bc3bd4f0ac49d9a1aa87239285
# Multiple things are broken with multithreaded compile
disable_parallel_build=yes

pre_configure() {
	autoreconf -i

	# Some things need to be compiled and/or run for the host system first
	# when cross-building.
	if [ "$CROSS_BUILD" ]; then
		CC=cc CXX=g++ LD=ld AR=ar RANLIB=ranlib CFLAGS="-static" \
			CXXFLAGS="-static" LDFLAGS="-static" ./configure
		for d in lib tools src/mup doc; do
			pushd $d
			make
			popd
		done
		# Clean some so they can be repopulated for the target arch.
		for d in lib tools/test src/mup; do
			pushd $d
			make clean
			popd
		done
		# Also don't do docs build again..
		patch -Np1 -i "${FILESDIR}/post-cross-fix.patch"
		autoreconf -i
	fi
}

pre_build() {
	# bbox is broken-ish in the Makefile, run it outside of the Makefile.
	# i.e. compiling + running it outside first *fixes* it re-running it
	# inside the Makefile..
	if ! [ "$CROSS_BUILD" ]; then
		pushd tools/mup
		make bbox
		popd
	fi
	pushd src/mup
	../../tools/mup/bbox
	popd
}

post_install() {
	vlicense LICENSE
}
